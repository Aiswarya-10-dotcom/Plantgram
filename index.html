<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PlantGram ðŸŒ¿</title>

<style>
  /* Reset & base */
  * { box-sizing: border-box; }
  body {
    margin: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #ffffff;
    color: #000;
    min-height: 100vh;
  }

  /* Navbar */
  header {
    position: fixed;
    top: 0; left: 0; right: 0;
    background: #3a6b35;
    color: #e9f5db;
    display: flex;
    justify-content: space-around;
    align-items: center;
    height: 55px;
    font-weight: 600;
    font-size: 1.1rem;
    box-shadow: 0 2px 5px rgba(0,0,0,0.15);
    z-index: 1000;
  }
  header nav a {
    color: #080204;
    text-decoration: none;
    cursor: pointer;
    padding: 8px 15px;
    border-radius: 6px;
    transition: background-color 0.3s;
  }
  header nav a:hover, header nav a.active {
    background: #a7d089; color: #4db727;
  }

  main {
    padding-top: 65px;
    max-width: 600px;
    margin: 0 auto 40px;
    min-height: calc(100vh - 65px);
  }

  /* Upload form */
  #upload-post {
    background: white;
    margin: 15px 10px;
    border-radius: 12px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    padding: 16px;
    font-size: 0.95rem;
    color: #2d3a26;
  }
  #upload-post label { display:block; margin-bottom:6px; font-weight:600; }
  #upload-post input[type="file"],
  #upload-post input[type="text"] {
    width:100%; padding:8px 10px; border-radius:8px;
    border:1.5px solid #a4c639; margin-bottom:12px; outline:none; font-size:0.9rem;
    transition:border-color .3s;
  }
  #upload-post input:focus { border-color:#588a28; }
  #upload-post button {
    background:#588a28; border:none; color:white; padding:10px 18px; border-radius:20px; font-weight:700; cursor:pointer;
  }
  #upload-post button:hover { background:#447a1b; }

  /* Post card */
  .post {
    background: white; margin: 15px 10px; border-radius:12px; box-shadow:0 3px 10px rgba(0,0,0,0.1);
    overflow:hidden; padding-bottom:10px; transition: background-color 1.5s ease;
  }
  .post img, .post video { width:100%; display:block; border-bottom:1px solid #ddd; cursor:pointer; transition:transform .3s ease; max-height:400px; object-fit:cover; }
  .post img:hover, .post video:hover { transform:scale(1.03); }
  .post-header { display:flex; align-items:center; gap:10px; padding:12px 16px 0 16px; font-weight:600; color:#3a6b35; }
  .post-avatar { width:34px; height:34px; border-radius:50%; background:#a7d089; color:#3a6b35; font-weight:700; display:flex; align-items:center; justify-content:center; user-select:none; font-size:1.1rem; }
  .caption { font-size:0.95rem; margin-bottom:8px; white-space:pre-wrap; padding: 0 16px; }

  .actions { display:flex; align-items:center; gap:15px; margin-bottom:10px; padding: 0 16px; }
  .like-btn { background:none; border:none; cursor:pointer; padding:0; display:flex; align-items:center; }
  .like-btn svg { width:24px; height:24px; fill:#6a994e; transition:fill .3s; }
  .like-btn.liked svg { fill:#379237; filter: drop-shadow(0 0 1.5px #2a6f2a); }

  /* Profile */
  #profile-container { background:white; margin:15px 10px; border-radius:12px; box-shadow:0 3px 10px rgba(0,0,0,0.1); padding:20px 24px; color:#2d3a26; }
  #profile-header { display:flex; align-items:center; gap:16px; margin-bottom:24px; }
  #profile-avatar { width:90px; height:90px; border-radius:50%; background:#a7d089; display:flex; align-items:center; justify-content:center; font-size:2.5rem; color:#3a6b35; }
  #follow-info { display:flex; gap:40px; font-size:1.1rem; margin-bottom:24px; }
  #followers-list, #following-list { margin-bottom:20px; }
  .user-list-item { padding:6px 0; border-bottom:1px solid #e0ebd7; display:flex; justify-content:space-between; align-items:center; }

  /* Search */
  #search-profile-container { margin:15px 10px 10px 10px; background:white; border-radius:12px; box-shadow:0 3px 10px rgba(0,0,0,0.1); padding:16px; }
  #search-results { margin-top:6px; max-height:120px; overflow-y:auto; border:1px solid #a4c639; border-radius:6px; background:#f5fbe8; }
  .search-result-item { padding:8px 12px; cursor:pointer; border-bottom:1px solid #a4c639; }
  .search-result-item:hover { background:#a7d089; color:#3a6b35; }

  /* Hide sections */
  .hidden { display:none !important; }

  /* ===== GAME: weeding game (improved visuals) ===== */
  #game-section { display:flex; gap:16px; padding:16px; align-items:flex-start; }
  #game-sidebar {
    width:220px; background: linear-gradient(180deg,#f2fbf2,#eaf7ea);
    border-radius:12px; padding:14px; border:1px solid #dbeed2; box-shadow: 0 6px 18px rgba(60,100,50,0.06);
  }
  #game-sidebar h3 { margin:6px 0 8px; color:#2f5a2a; }
  #game-sidebar p { font-size:0.95rem; color:#436b36; margin-bottom:12px; }
  .game-btn { display:block; width:100%; background:#588a28; color:white; border:none; padding:10px 12px; border-radius:10px; font-weight:700; cursor:pointer; margin-bottom:8px; }
  .game-btn:hover { background:#447a1b; }

  #game-content {
    flex:1; background: linear-gradient(180deg,#ffffff,#f6fff6); border-radius:12px; padding:12px; box-shadow:0 6px 18px rgba(60,100,50,0.04);
  }

  /* canvas area */
  #game-canvas-wrap { display:flex; gap:12px; align-items:flex-start; }
  #game-canvas { background: linear-gradient(#dff2d8,#bfe6b0); border-radius:10px; padding:8px; box-shadow: inset 0 -10px 40px rgba(0,0,0,0.03); }
  canvas { display:block; background: transparent; border-radius:6px; }

  #game-info { margin-top:12px; display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  .info-pill { background:#ecf8ea; border:1px solid #d2efd1; color:#2f5a2a; padding:8px 10px; border-radius:999px; font-weight:700; box-shadow:0 2px 6px rgba(0,0,0,0.04); }

  /* instructions */
  .game-instructions { margin-top:10px; color:#3a6b35; font-size:0.95rem; }

  /* success/fail visuals */
  #game-overlay {
    position:relative;
    margin-top:8px;
    min-height:40px;
  }
  #game-message {
    color:#234d23;
    font-weight:700;
    padding:8px 10px;
    border-radius:8px;
    display:inline-block;
    background:linear-gradient(180deg,#f5fff5,#e9f7ea);
    border:1px solid #d6eed4;
  }

  /* ===== Chat styles reused from earlier ===== */
  #chat-section { display:flex; height:480px; background:#f5f9f4; border-radius:12px; overflow:hidden; box-shadow:0 3px 10px rgba(0,0,0,0.06); margin:15px 10px; }
  #chat-users { width:200px; background:#eaf6e7; border-right:1px solid #d8efd2; overflow:auto; padding:0; }
  .chat-user { padding:12px 14px; border-bottom:1px solid #d8efd2; cursor:pointer; }
  .chat-user:hover { background:#dff0d8; }
  #chat-window { flex:1; display:flex; flex-direction:column; }
  #chat-messages { flex:1; padding:14px; overflow:auto; display:flex; flex-direction:column; gap:10px; }
  .message { max-width:70%; padding:10px 12px; border-radius:12px; }
  .message.sent { align-self:flex-end; background:#a7d089; color:#07320a; }
  .message.received { align-self:flex-start; background:#d9edcf; color:#0a2b0b; }
  #chat-input-container { border-top:1px solid #d8efd2; display:flex; padding:10px; }
  #chat-input { flex:1; padding:10px 12px; border-radius:20px; border:1px solid #cfe9bd; outline:none; }

  /* small responsive tweak for narrow screens */
  @media (max-width:720px) {
    main { max-width:98%; }
    #game-section { flex-direction:column; }
    #game-sidebar { width:100% }
    #game-canvas { width:100% }
  }
</style>
</head>
<body>

<header>
  <nav>
    <a href="#" class="active" id="nav-home">Home</a>
    <a href="#" id="nav-feed">Feed</a>
    <a href="#" id="nav-profile">Profile</a>
    <!-- NEW: Game & Chat nav items -->
    <a href="#" id="nav-game">game</a>
    <a href="#" id="nav-chat">Chat</a>
  </nav>
</header>

<main>
  <!-- Home -->
  <section id="home-section">
    <section id="upload-post" aria-label="Upload new post">
      <form id="upload-form">
        <label for="media-input">Upload Image or Video</label>
        <input type="file" id="media-input" accept="image/*,video/*" required />
        <label for="caption-input">Caption</label>
        <input type="text" id="caption-input" placeholder="Write a caption..." maxlength="200" />
        <button type="submit">Post</button>
      </form>
    </section>

    <section id="user-posts-container" aria-live="polite" aria-atomic="true" aria-relevant="additions">
      <!-- Your own posts here -->
    </section>
  </section>

  <!-- Feed -->
  <section id="feed-section" class="hidden" aria-label="Public Feed">
    <section id="feed-posts-container" aria-live="polite" aria-atomic="true" aria-relevant="additions">
      <!-- All posts here -->
    </section>
  </section>

  <!-- Profile -->
  <section id="profile-section" class="hidden" aria-label="User Profile and Search">
    <div id="search-profile-container" role="search">
      <input type="search" id="search-profile-input" placeholder="Search users by username..." aria-label="Search profiles" autocomplete="off" />
      <div id="search-results" role="listbox" aria-label="Search results"></div>
    </div>

    <section id="view-other-profile" class="hidden" aria-live="polite" aria-atomic="true" aria-relevant="additions">
      <h2 id="other-profile-username"></h2>
      <div id="other-follow-info" style="display:flex;gap:40px;margin-bottom:20px;">
        <div><strong><span id="other-followers-count">0</span></strong> Followers</div>
        <div><strong><span id="other-following-count">0</span></strong> Following</div>
      </div>
      <div id="other-followers-list"><h3>Followers</h3><div id="other-followers-items"></div></div>
      <div id="other-following-list"><h3>Following</h3><div id="other-following-items"></div></div>
      <button id="back-to-own-profile-btn">Back to My Profile</button>
    </section>

    <div id="profile-container" aria-label="Your Profile">
      <div id="profile-header">
        <div id="profile-avatar" aria-hidden="true">ðŸŒ¿</div>
        <div>
          <div id="profile-username">plantlover123</div>
        </div>
      </div>

      <div id="follow-info">
        <div><strong><span id="followers-count">0</span></strong> Followers</div>
        <div><strong><span id="following-count">0</span></strong> Following</div>
      </div>

      <div id="followers-list">
        <h3>Followers</h3>
        <div id="followers-items"></div>
      </div>

      <div id="following-list">
        <h3>Following</h3>
        <div id="following-items"></div>
      </div>
    </div>
  </section>

  <!-- ===== NEW: Game section (Weeding Game only) ===== -->
  <section id="game-section" class="hidden" aria-label="Plant Game">
    <aside id="game-sidebar">
      <h3>Weed & Care ðŸŒ±</h3>
      <p>Pull the weeds before they take over! Use the arrow keys to move the spade and press <strong>Space</strong> to weed. Each weed pulled = +1 score. Avoid pulling healthy plants.</p>
      <button class="game-btn" id="start-game-btn">Start Game</button>
      <button class="game-btn" id="restart-game-btn" style="background:#a7d089;color:#06380b">Restart</button>
      <div class="game-instructions">
        <ul style="padding-left:18px;margin:8px 0;color:#3a6b35">
          <li>Arrows â€” Move spade</li>
          <li>Space â€” Pull (weed)</li>
          <li>Timer: 30s per round</li>
        </ul>
      </div>
    </aside>

    <div id="game-content" role="application" aria-label="Weeding game area">
      <div id="game-canvas-wrap">
        <div id="game-canvas" aria-hidden="false">
          <!-- Canvas will be injected here -->
          <canvas id="weed-canvas" width="360" height="360" tabindex="0"></canvas>
        </div>

        <div style="min-width:150px;">
          <div id="game-info">
            <div class="info-pill">Score: <span id="game-score">0</span></div>
            <div class="info-pill">Time: <span id="game-timer">30</span>s</div>
            <div class="info-pill">Level: <span id="game-level">1</span></div>
          </div>

          <div id="game-overlay">
            <div id="game-message">Press <strong>Start Game</strong> to begin weeding!</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- ===== NEW: Chat section ===== -->
  <section id="chat-section" class="hidden" aria-label="Chat with followers">
    <div id="chat-users" aria-label="Followers list">
      <!-- follower items injected here -->
    </div>
    <div id="chat-window" aria-label="Chat window">
      <div id="chat-messages" role="log" aria-live="polite" aria-atomic="false"></div>
      <div id="chat-input-container">
        <input type="text" id="chat-input" placeholder="Type a message and press Enter..." aria-label="Message input" />
      </div>
    </div>
  </section>
</main>

<script>
  // --- existing social app data + UI (unchanged functionality) ---
  const posts = [
    { id: 1, mediaType: 'image', mediaSrc: 'https://images.unsplash.com/photo-1501004318641-b39e6451bec6?auto=format&fit=crop&w=600&q=80', caption: "My thriving Monstera Deliciosa ðŸŒ¿ #plantlove", likes: 23, comments: [], likedByUser: false, owner: 'plantlover123' },
    { id: 2, mediaType: 'image', mediaSrc: 'https://images.unsplash.com/photo-1468071174046-657d9d351a40?auto=format&fit=crop&w=600&q=80', caption: "Succulent Sunday vibes ðŸŒµâœ¨", likes: 37, comments: [], likedByUser: false, owner: 'plantlover123' },
    { id: 3, mediaType: 'image', mediaSrc: 'https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=600&q=80', caption: "Peace Lily in full bloom ðŸŒ¸", likes: 15, comments: [], likedByUser: false, owner: 'flora_fan' },
    { id: 4, mediaType: 'video', mediaSrc: 'https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.webm', caption: "Sunflowers dancing in the wind ðŸŒ»", likes: 42, comments: [], likedByUser: false, owner: 'cactus_queen' },
  ];

  const allUsers = {
    'plantlover123': { username: 'plantlover123', followers: ['green_thumb', 'leafy_lover', 'succulent_sam'], following: ['flora_fan', 'cactus_queen'] },
    'green_thumb': { username: 'green_thumb', followers: ['plantlover123'], following: ['succulent_sam'] },
    'leafy_lover': { username: 'leafy_lover', followers: [], following: ['plantlover123', 'flora_fan'] },
    'succulent_sam': { username: 'succulent_sam', followers: ['green_thumb'], following: [] },
    'flora_fan': { username: 'flora_fan', followers: ['plantlover123', 'leafy_lover'], following: ['cactus_queen'] },
    'cactus_queen': { username: 'cactus_queen', followers: ['flora_fan'], following: ['plantlover123'] },
  };

  const loggedInUsername = 'plantlover123';
  let currentViewedProfile = null;

  // DOM refs
  const navHome = document.getElementById('nav-home');
  const navFeed = document.getElementById('nav-feed');
  const navProfile = document.getElementById('nav-profile');
  const navGame = document.getElementById('nav-game');
  const navChat = document.getElementById('nav-chat');

  const homeSection = document.getElementById('home-section');
  const feedSection = document.getElementById('feed-section');
  const profileSection = document.getElementById('profile-section');
  const gameSection = document.getElementById('game-section');
  const chatSection = document.getElementById('chat-section');

  const uploadForm = document.getElementById('upload-form');
  const mediaInput = document.getElementById('media-input');
  const captionInput = document.getElementById('caption-input');
  const userPostsContainer = document.getElementById('user-posts-container');
  const feedPostsContainer = document.getElementById('feed-posts-container');

  const profileUsernameEl = document.getElementById('profile-username');
  const followersCountEl = document.getElementById('followers-count');
  const followingCountEl = document.getElementById('following-count');
  const followersItemsEl = document.getElementById('followers-items');
  const followingItemsEl = document.getElementById('following-items');

  const searchInput = document.getElementById('search-profile-input');
  const searchResultsEl = document.getElementById('search-results');

  const viewOtherProfileSection = document.getElementById('view-other-profile');
  const otherProfileUsernameEl = document.getElementById('other-profile-username');

  const otherFollowersCountEl = document.getElementById('other-followers-count');
  const otherFollowingCountEl = document.getElementById('other-following-count');
  const otherFollowersItemsEl = document.getElementById('other-followers-items');
  const otherFollowingItemsEl = document.getElementById('other-following-items');
  const backToOwnProfileBtn = document.getElementById('back-to-own-profile-btn');

  function createPlantSVG() {
    const svgNS = "http://www.w3.org/2000/svg";
    const svg = document.createElementNS(svgNS, "svg");
    svg.setAttribute("viewBox", "0 0 24 24");
    svg.setAttribute("aria-hidden", "true");
    svg.innerHTML = `<path d="M12 2C9.243 5.134 7.5 7.5 7.5 10c0 2.49 3 6 4.5 6s4.5-3.51 4.5-6c0-2.5-1.743-4.866-4.5-8z" />`;
    return svg;
  }

  function renderPost(post, container, isUserPost = false) {
    const postEl = document.createElement('article');
    postEl.className = 'post';
    postEl.setAttribute('tabindex','0');

    const postHeader = document.createElement('div'); postHeader.className='post-header';
    const avatar = document.createElement('div'); avatar.className='post-avatar'; avatar.textContent = post.owner.charAt(0).toUpperCase(); avatar.setAttribute('aria-hidden','true');
    const username = document.createElement('div'); username.className='post-username'; username.textContent = post.owner;
    postHeader.appendChild(avatar); postHeader.appendChild(username);

    let mediaEl;
    if (post.mediaType === 'image') {
      mediaEl = document.createElement('img'); mediaEl.src = post.mediaSrc; mediaEl.alt = `Photo posted by ${post.owner}`;
    } else {
      mediaEl = document.createElement('video'); mediaEl.src = post.mediaSrc; mediaEl.setAttribute('controls','true'); mediaEl.setAttribute('aria-label',`Video posted by ${post.owner}`);
    }

    const caption = document.createElement('div'); caption.className='caption'; caption.textContent = post.caption;

    const actions = document.createElement('div'); actions.className='actions';
    const likeBtn = document.createElement('button'); likeBtn.className='like-btn'; likeBtn.setAttribute('aria-label','Like post'); likeBtn.setAttribute('aria-pressed', post.likedByUser ? 'true' : 'false'); likeBtn.title = 'Like post';
    likeBtn.appendChild(createPlantSVG());
    if (post.likedByUser) likeBtn.classList.add('liked');
    const likesCount = document.createElement('div'); likesCount.className='likes-count'; likesCount.textContent = `${post.likes} likes`;

    likeBtn.addEventListener('click', () => {
      post.likedByUser = !post.likedByUser;
      post.likes += post.likedByUser ? 1 : -1;
      likeBtn.classList.toggle('liked');
      likeBtn.setAttribute('aria-pressed', post.likedByUser ? 'true' : 'false');
      likesCount.textContent = `${post.likes} likes`;
    });

    actions.appendChild(likeBtn); actions.appendChild(likesCount);
    if (post.comments && post.comments.length>0) {
      const commentsCount = document.createElement('div'); commentsCount.className='comments-count'; commentsCount.textContent = `${post.comments.length} comments`; actions.appendChild(commentsCount);
    }

    postEl.appendChild(postHeader);
    postEl.appendChild(mediaEl);
    postEl.appendChild(caption);
    postEl.appendChild(actions);
    container.appendChild(postEl);
  }

  function renderUserPosts() {
    userPostsContainer.innerHTML = '';
    const userPosts = posts.filter(p => p.owner === loggedInUsername);
    if (userPosts.length === 0) userPostsContainer.textContent = "You haven't posted anything yet.";
    else userPosts.forEach(p => renderPost(p, userPostsContainer, true));
  }

  function renderFeedPosts() {
    feedPostsContainer.innerHTML = '';
    posts.forEach(p => renderPost(p, feedPostsContainer));
  }

  function renderProfile(username) {
    if (!(username in allUsers)) { alert("User not found."); return; }
    currentViewedProfile = username;

    if (username === loggedInUsername) {
      profileUsernameEl.textContent = username;
      followersCountEl.textContent = allUsers[username].followers.length;
      followingCountEl.textContent = allUsers[username].following.length;

      followersItemsEl.innerHTML = '';
      allUsers[username].followers.forEach(f => { const div=document.createElement('div'); div.className='user-list-item'; div.textContent=f; followersItemsEl.appendChild(div); });

      followingItemsEl.innerHTML = '';
      allUsers[username].following.forEach(f => { const div=document.createElement('div'); div.className='user-list-item'; div.textContent=f; followingItemsEl.appendChild(div); });

      viewOtherProfileSection.classList.add('hidden');
      profileSection.querySelector('#profile-container').classList.remove('hidden');
      document.getElementById('search-profile-container').style.display = 'block';
    } else {
      const user = allUsers[username];
      otherProfileUsernameEl.textContent = user.username;
      otherFollowersCountEl.textContent = user.followers.length;
      otherFollowingCountEl.textContent = user.following.length;

      otherFollowersItemsEl.innerHTML = '';
      user.followers.forEach(f => { const div=document.createElement('div'); div.className='user-list-item'; div.textContent=f; otherFollowersItemsEl.appendChild(div); });

      otherFollowingItemsEl.innerHTML = '';
      user.following.forEach(f => { const div=document.createElement('div'); div.className='user-list-item'; div.textContent=f; otherFollowingItemsEl.appendChild(div); });

      viewOtherProfileSection.classList.remove('hidden');
      profileSection.querySelector('#profile-container').classList.add('hidden');
      searchResultsEl.innerHTML = '';
    }
  }

  function searchUsers(term) {
    const termLower = term.trim().toLowerCase();
    if (!termLower) { searchResultsEl.innerHTML=''; renderProfile(loggedInUsername); return; }
    const results = Object.keys(allUsers).filter(u => u.toLowerCase().includes(termLower));
    renderSearchResults(results);
  }

  function renderSearchResults(results) {
    searchResultsEl.innerHTML = '';
    if (results.length===0) { searchResultsEl.innerHTML = '<div class="search-result-item" aria-disabled="true">No users found</div>'; return; }
    results.forEach(username => {
      const item = document.createElement('div'); item.className='search-result-item'; item.textContent=username; item.setAttribute('role','option'); item.tabIndex=0;
      item.addEventListener('click', ()=> { searchInput.value=username; searchResultsEl.innerHTML=''; renderProfile(username); });
      item.addEventListener('keydown', (e)=> { if (e.key==='Enter'||e.key===' ') { e.preventDefault(); item.click(); }});
      searchResultsEl.appendChild(item);
    });
  }

  backToOwnProfileBtn.addEventListener('click', ()=> { searchInput.value=''; searchResultsEl.innerHTML=''; renderProfile(loggedInUsername); });

  function clearActiveNav() {
    navHome.classList.remove('active'); navFeed.classList.remove('active'); navProfile.classList.remove('active');
    if (navGame) navGame.classList.remove('active'); if (navChat) navChat.classList.remove('active');
  }
  navHome.addEventListener('click', (e)=> { e.preventDefault(); clearActiveNav(); navHome.classList.add('active');
    homeSection.classList.remove('hidden'); feedSection.classList.add('hidden'); profileSection.classList.add('hidden'); gameSection.classList.add('hidden'); chatSection.classList.add('hidden');
    renderUserPosts();
  });
  navFeed.addEventListener('click', (e)=> { e.preventDefault(); clearActiveNav(); navFeed.classList.add('active');
    homeSection.classList.add('hidden'); feedSection.classList.remove('hidden'); profileSection.classList.add('hidden'); gameSection.classList.add('hidden'); chatSection.classList.add('hidden');
    renderFeedPosts();
  });
  navProfile.addEventListener('click', (e)=> { e.preventDefault(); clearActiveNav(); navProfile.classList.add('active');
    homeSection.classList.add('hidden'); feedSection.classList.add('hidden'); profileSection.classList.remove('hidden'); gameSection.classList.add('hidden'); chatSection.classList.add('hidden');
    renderProfile(loggedInUsername);
  });

  // Game and Chat nav handlers
  navGame.addEventListener('click', (e)=> {
    e.preventDefault(); clearActiveNav(); navGame.classList.add('active');
    homeSection.classList.add('hidden'); feedSection.classList.add('hidden'); profileSection.classList.add('hidden');
    gameSection.classList.remove('hidden'); chatSection.classList.add('hidden');
  });

  navChat.addEventListener('click', (e)=> {
    e.preventDefault(); clearActiveNav(); navChat.classList.add('active');
    homeSection.classList.add('hidden'); feedSection.classList.add('hidden'); profileSection.classList.add('hidden');
    gameSection.classList.add('hidden'); chatSection.classList.remove('hidden');
  });

  // Upload form
  uploadForm.addEventListener('submit', (e)=> {
    e.preventDefault();
    const file = mediaInput.files[0];
    if (!file) { alert('Please select an image or video.'); return; }
    const caption = captionInput.value.trim();
    const reader = new FileReader();
    reader.onload = function(evt) {
      let mediaType = '';
      if (file.type.startsWith('image/')) mediaType='image';
      else if (file.type.startsWith('video/')) mediaType='video';
      else { alert('Unsupported file type. Only images and videos allowed.'); return; }
      const newPost = { id: posts.length+1, mediaType, mediaSrc: evt.target.result, caption, likes:0, comments:[], likedByUser:false, owner: loggedInUsername };
      posts.unshift(newPost);
      renderUserPosts();
      captionInput.value=''; mediaInput.value='';
      alert('Post uploaded successfully!');
    };
    reader.readAsDataURL(file);
  });

  searchInput.addEventListener('input', ()=> {
    const val = searchInput.value.trim();
    if (val==='') { searchResultsEl.innerHTML=''; renderProfile(loggedInUsername); } else searchUsers(val);
  });

  // initial render
  renderUserPosts();

  // ===== NEW: Game (weeding) logic =====
  const canvas = document.getElementById('weed-canvas');
  const ctx = canvas.getContext('2d');
  const CANVAS_SIZE = 360;
  const GRID_SIZE = 8; // 8x8 grid
  const TILE = CANVAS_SIZE / GRID_SIZE;
  const startBtn = document.getElementById('start-game-btn');
  const restartBtn = document.getElementById('restart-game-btn');
  const scoreEl = document.getElementById('game-score');
  const timerEl = document.getElementById('game-timer');
  const levelEl = document.getElementById('game-level');
  const msgEl = document.getElementById('game-message');

  let grid = []; // 0 = grass, 1 = weed, 2 = plant (don't pull), 3 = empty (dug)
  let spade = { x: 0, y: 0 }; // spade cursor
  let score = 0;
  let timeLeft = 30;
  let timerId = null;
  let level = 1;
  let running = false;

  function createGrid(weedChance = 0.12, plantChance = 0.10) {
    grid = [];
    for (let y=0; y<GRID_SIZE; y++) {
      const row = [];
      for (let x=0; x<GRID_SIZE; x++) {
        const r = Math.random();
        if (r < weedChance) row.push(1); // weed
        else if (r < weedChance + plantChance) row.push(2); // healthy plant
        else row.push(0); // grass
      }
      grid.push(row);
    }
  }

  function drawGrid() {
    // background
    ctx.clearRect(0,0,CANVAS_SIZE,CANVAS_SIZE);
    // subtle pattern
    for (let y=0;y<GRID_SIZE;y++){
      for (let x=0;x<GRID_SIZE;x++){
        const val = grid[y][x];
        const px = x*TILE, py = y*TILE;
        // base patch
        ctx.fillStyle = '#9edb89'; // patch grass
        ctx.fillRect(px,py,TILE-1,TILE-1);
        // variations: add blades or weeds/plant
        if (val === 1) {
          // weed - darker, curly
          drawWeed(px,py);
        } else if (val === 2) {
          // healthy plant - flower / leaf
          drawPlant(px,py);
        } else if (val === 3) {
          // dug empty patch
          ctx.fillStyle = '#d1bfa3';
          ctx.fillRect(px+4, py+TILE/2, TILE-8, TILE/2 - 6);
        } else {
          // just grass blades
          drawGrassBlades(px,py);
        }
      }
    }
    // draw spade cursor
    drawSpade(spade.x, spade.y);
  }

  function drawGrassBlades(px,py) {
    ctx.strokeStyle = 'rgba(22,70,20,0.25)';
    ctx.lineWidth = 1;
    for (let i=0;i<3;i++){
      ctx.beginPath();
      ctx.moveTo(px + 6 + i*6, py + TILE - 6);
      ctx.quadraticCurveTo(px + 6 + i*6, py + TILE - 16, px + 6 + i*6 - 2, py + TILE - 24);
      ctx.stroke();
    }
  }

  function drawWeed(px,py) {
    // little darker tuft with a circular center
    ctx.fillStyle = '#2f6b2a';
    ctx.beginPath();
    ctx.ellipse(px + TILE/2, py + TILE/2 + 4, TILE/3.2, TILE/4.5, 0, 0, Math.PI*2);
    ctx.fill();
    // curly tendrils
    ctx.strokeStyle = '#183a12';
    ctx.lineWidth = 1;
    for (let i=0;i<3;i++){
      ctx.beginPath();
      ctx.moveTo(px + TILE/2, py + TILE/2 + 2);
      ctx.bezierCurveTo(px + TILE/2 + (i-1)*8, py + TILE/2 - 14, px + TILE/2 + (i-1)*10, py + 6, px + TILE/2 + (i-1)*6, py + 4);
      ctx.stroke();
    }
  }

  function drawPlant(px,py) {
    // healthy plant: bright leaf + small flower
    ctx.fillStyle = '#70b56f';
    ctx.beginPath();
    ctx.ellipse(px + TILE/2 - 6, py + TILE/2, 10, 16, -0.6, 0, Math.PI*2);
    ctx.fill();
    ctx.beginPath();
    ctx.ellipse(px + TILE/2 + 6, py + TILE/2, 10, 16, 0.6, 0, Math.PI*2);
    ctx.fill();
    // flower
    ctx.fillStyle = '#ffefc0';
    ctx.beginPath();
    ctx.arc(px + TILE/2, py + TILE/2 - 6, 5, 0, Math.PI*2);
    ctx.fill();
    ctx.fillStyle = '#f08a5d';
    ctx.fillRect(px + TILE/2 - 1, py + TILE/2 - 3, 2, 8);
  }

  function drawSpade(gx,gy) {
    const px = gx*TILE, py = gy*TILE;
    // shadow
    ctx.fillStyle = 'rgba(0,0,0,0.08)';
    ctx.fillRect(px+6, py+TILE-8, TILE-12, 6);
    // handle
    ctx.fillStyle = '#6b4a2a';
    ctx.fillRect(px + TILE/2 - 3, py + 8, 6, TILE/2);
    // blade
    ctx.fillStyle = '#3b3b3b';
    ctx.beginPath();
    ctx.moveTo(px + TILE/2 - 10, py + 8);
    ctx.lineTo(px + TILE/2 + 10, py + 8);
    ctx.lineTo(px + TILE/2 + 3, py + 22);
    ctx.lineTo(px + TILE/2 - 3, py + 22);
    ctx.closePath();
    ctx.fill();
    // highlight when over tile
    ctx.strokeStyle = '#ffffff66'; ctx.lineWidth = 1;
    ctx.strokeRect(px+1, py+1, TILE-2, TILE-2);
  }

  function placeRandomWeed() {
    // occasionally add new weeds over time
    const x = Math.floor(Math.random()*GRID_SIZE), y = Math.floor(Math.random()*GRID_SIZE);
    if (grid[y][x] === 0) grid[y][x] = 1;
  }

  function startGame() {
    if (running) return;
    score = 0; scoreEl.textContent = score;
    level = 1; levelEl.textContent = level;
    timeLeft = 30; timerEl.textContent = timeLeft;
    createGrid(0.12 + (level-1)*0.02, 0.10); // slight difficulty scaling
    spade = { x: Math.floor(GRID_SIZE/2), y: Math.floor(GRID_SIZE/2) };
    msgEl.textContent = 'Game on! Pull weeds (Space). Avoid healthy plants.';
    running = true;
    drawGrid();
    // timer
    timerId = setInterval(() => {
      timeLeft -= 1; timerEl.textContent = timeLeft;
      // increase chance of new weeds as time goes
      if (Math.random() < 0.35) placeRandomWeed();
      drawGrid();
      if (timeLeft <= 0) {
        endGame();
      }
    }, 1000);
    // give canvas focus for keyboard controls
    canvas.focus();
  }

  function restartGame() {
    clearInterval(timerId);
    running = false;
    score = 0; scoreEl.textContent = 0;
    timeLeft = 30; timerEl.textContent = 30;
    level = 1; levelEl.textContent = level;
    createGrid(0.12, 0.10);
    spade = { x: Math.floor(GRID_SIZE/2), y: Math.floor(GRID_SIZE/2) };
    drawGrid();
    msgEl.textContent = 'Game reset. Press Start Game to play!';
  }

  function endGame() {
    clearInterval(timerId);
    running = false;
    msgEl.textContent = `Time's up! Final score: ${score}. Press Restart to play again.`;
  }

  function moveSpade(dx,dy) {
    if (!running) return;
    const nx = Math.max(0, Math.min(GRID_SIZE-1, spade.x + dx));
    const ny = Math.max(0, Math.min(GRID_SIZE-1, spade.y + dy));
    spade.x = nx; spade.y = ny;
    drawGrid();
  }

  function pullWeed() {
    if (!running) return;
    const tile = grid[spade.y][spade.x];
    if (tile === 1) {
      // pulled a weed => good
      grid[spade.y][spade.x] = 3; // dug
      score += 1;
      scoreEl.textContent = score;
      // small chance to spawn a bonus weed elsewhere
      if (Math.random() < 0.12) placeRandomWeed();
      msgEl.textContent = `Nice! +1 (Score: ${score}) ðŸŒ¿`;
    } else if (tile === 2) {
      // pulled a healthy plant => penalty
      grid[spade.y][spade.x] = 3;
      score = Math.max(0, score - 2);
      scoreEl.textContent = score;
      msgEl.textContent = `Oh no â€” that was a healthy plant! -2 penalty.`;
    } else if (tile === 0) {
      // nothing there
      msgEl.textContent = `Just dirt... no weed here.`;
    } else if (tile === 3) {
      msgEl.textContent = `Patch already cleared.`;
    }
    // small level up for score thresholds
    const newLevel = Math.floor(score / 8) + 1;
    if (newLevel > level) {
      level = newLevel;
      levelEl.textContent = level;
      msgEl.textContent = `Level up! Now level ${level} â€” weeds get busier.`;
      // make game slightly harder
      for (let i=0;i<Math.min(level,4);i++) placeRandomWeed();
    }
    drawGrid();
  }

  // keyboard controls
  document.addEventListener('keydown', (e) => {
    if (document.activeElement && (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA')) {
      // don't hijack input typing
      return;
    }
    if (!running && (e.key === 'ArrowUp' || e.key === 'ArrowDown' || e.key==='ArrowLeft' || e.key==='ArrowRight' || e.key===' ')) {
      // do nothing, game not started
      return;
    }
    switch (e.key) {
      case 'ArrowUp': moveSpade(0,-1); e.preventDefault(); break;
      case 'ArrowDown': moveSpade(0,1); e.preventDefault(); break;
      case 'ArrowLeft': moveSpade(-1,0); e.preventDefault(); break;
      case 'ArrowRight': moveSpade(1,0); e.preventDefault(); break;
      case ' ':
        e.preventDefault();
        pullWeed();
        break;
      default: break;
    }
  });

  // canvas focus handling (allow clicks to move spade)
  canvas.addEventListener('click', (ev) => {
    const rect = canvas.getBoundingClientRect();
    const cx = ev.clientX - rect.left;
    const cy = ev.clientY - rect.top;
    const gx = Math.floor(cx / TILE);
    const gy = Math.floor(cy / TILE);
    if (gx>=0 && gx<GRID_SIZE && gy>=0 && gy<GRID_SIZE) {
      spade.x = gx; spade.y = gy;
      drawGrid();
    }
  });

  startBtn.addEventListener('click', () => {
    startGame();
  });
  restartBtn.addEventListener('click', () => {
    restartGame();
  });

  // initialize grid/visual
  createGrid(0.12,0.10);
  drawGrid();

  // small autoplay: gentle weed spawn so canvas looks alive
  setInterval(()=> {
    if (!running && Math.random() < 0.05) {
      placeRandomWeed();
      drawGrid();
    }
  }, 1500);

  // ===== NEW: Chat logic (unchanged) =====
  const chatUsersContainer = document.getElementById('chat-users');
  const chatMessagesContainer = document.getElementById('chat-messages');
  const chatInput = document.getElementById('chat-input');
  let activeChatUser = null;
  const chatHistory = {}; // in-memory

  function renderChatUsers() {
    chatUsersContainer.innerHTML = '';
    const followersList = (allUsers[loggedInUsername] && allUsers[loggedInUsername].followers) ? allUsers[loggedInUsername].followers : [];
    followersList.forEach(user => {
      const div = document.createElement('div');
      div.className = 'chat-user';
      div.textContent = user;
      div.tabIndex = 0;
      div.addEventListener('click', () => openChat(user));
      div.addEventListener('keydown', (e) => { if (e.key === 'Enter') openChat(user); });
      chatUsersContainer.appendChild(div);
    });
    if (followersList.length === 0) {
      chatUsersContainer.innerHTML = '<div style="padding:12px;color:#4a6a2c">No followers to chat with.</div>';
    }
  }

  function openChat(user) {
    activeChatUser = user;
    chatMessagesContainer.innerHTML = '';
    if (!chatHistory[user]) chatHistory[user] = [];
    chatHistory[user].forEach(m => addMessageToUI(m.text, m.sender === loggedInUsername));
    // focus input for convenience
    chatInput.focus();
  }

  function addMessageToUI(text, sent) {
    const msg = document.createElement('div');
    msg.className = 'message ' + (sent ? 'sent' : 'received');
    msg.textContent = text;
    chatMessagesContainer.appendChild(msg);
    chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
  }

  chatInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      const text = chatInput.value.trim();
      if (!text) return;
      if (!activeChatUser) { alert('Select a follower to chat with from the left.'); return; }
      if (!chatHistory[activeChatUser]) chatHistory[activeChatUser] = [];
      chatHistory[activeChatUser].push({ sender: loggedInUsername, text });
      addMessageToUI(text, true);
      chatInput.value = '';
      setTimeout(() => {
        const reply = `ðŸŒ¿ ${activeChatUser}: thanks for the message!`;
        chatHistory[activeChatUser].push({ sender: activeChatUser, text: reply });
        if (activeChatUser) addMessageToUI(reply, false);
      }, 700);
    }
  });

  renderChatUsers();

</script>
</body>
</html>
